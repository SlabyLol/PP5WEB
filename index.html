<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poppy Playtime Ch. 5 - Mobile & PC Fixed</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nosifer&family=Oswald:wght@700&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; touch-action: none; }
        canvas { display: block; }

        /* --- MENÜ --- */
        #menu-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle, #200 0%, #000 90%);
            z-index: 100; transition: 0.8s;
        }
        .menu-box { text-align: center; }
        h1 { font-family: 'Nosifer', sans-serif; color: #f00; font-size: 2.5rem; margin: 0; text-shadow: 0 0 15px #f00; }
        .btn {
            background: #111; color: #fff; border: 2px solid #444; padding: 15px;
            font-size: 1.2rem; cursor: pointer; margin: 10px; width: 220px; font-family: 'Oswald';
        }

        /* --- MOBILE UI CONTROLS --- */
        #mobile-controls {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; pointer-events: none; z-index: 50;
        }
        /* Joystick links */
        #joystick-base {
            position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; pointer-events: auto;
        }
        #joystick-knob {
            position: absolute; top: 25px; left: 25px; width: 50px; height: 50px;
            background: rgba(255,255,255,0.5); border-radius: 50%;
        }
        /* Hand Buttons rechts */
        .hand-btn {
            position: absolute; bottom: 40px; width: 70px; height: 70px;
            border-radius: 15px; border: 3px solid #000; pointer-events: auto;
        }
        #btn-blue { right: 120px; background: #0088ff; box-shadow: 0 0 15px #0088ff; }
        #btn-red { right: 30px; background: #ff0000; box-shadow: 0 0 15px #ff0000; }

        #jumpscare {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: none; z-index: 200;
            color: red; font-family: 'Nosifer'; font-size: 3rem;
            justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div id="menu-overlay">
        <div class="menu-box">
            <h1>POPPY PLAYTIME</h1>
            <p style="color: #666;">CHAPTER 5 REMAKE</p>
            <button class="btn" onclick="initGame()">SPIEL STARTEN</button>
        </div>
    </div>

    <div id="mobile-controls">
        <div id="joystick-base"><div id="joystick-knob"></div></div>
        <div id="btn-blue" class="hand-btn" onpointerdown="shoot('blue')"></div>
        <div id="btn-red" class="hand-btn" onpointerdown="shoot('red')"></div>
    </div>

    <div id="jumpscare">GEFRESSEN!</div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        let gameActive = false;
        let moveData = { x: 0, y: 0 };
        let lookData = { lat: 0, lon: -90 };

        // --- ENGINE SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.15);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- LICHT (VIEL STÄRKER) ---
        const light = new THREE.PointLight(0xffffff, 50, 20); // Taschenlampe
        camera.add(light);
        const amb = new THREE.AmbientLight(0x404040, 0.5); // Grundlicht damit man was sieht
        scene.add(amb);
        scene.add(camera);

        // --- WELT ---
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x111111 }));
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        for(let i = 0; i < 20; i++) {
            const wall = new THREE.Mesh(new THREE.BoxGeometry(1, 6, 10), new THREE.MeshStandardMaterial({ color: 0x221111 }));
            wall.position.set(4, 3, -i * 10);
            scene.add(wall);
            const wallL = wall.clone(); wallL.position.x = -4; scene.add(wallL);
        }

        // --- GRABPACK ---
        const blueHand = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.4), new THREE.MeshStandardMaterial({ color: 0x0088ff }));
        const redHand = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.4), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
        blueHand.position.set(-0.5, -0.4, -0.8);
        redHand.position.set(0.5, -0.4, -0.8);
        camera.add(blueHand); camera.add(redHand);

        // --- START FUNKTION ---
        window.initGame = () => {
            document.getElementById('menu-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('menu-overlay').style.display = 'none';
                document.getElementById('mobile-controls').style.display = 'block';
                gameActive = true;
                animate();
            }, 800);
        };

        // --- MOBILE JOYSTICK LOGIK ---
        const knob = document.getElementById('joystick-knob');
        document.getElementById('joystick-base').addEventListener('pointermove', (e) => {
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left - 50;
            const y = e.clientY - rect.top - 50;
            const dist = Math.min(Math.sqrt(x*x + y*y), 40);
            const angle = Math.atan2(y, x);
            
            knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
            moveData.x = Math.cos(angle) * (dist/40);
            moveData.y = Math.sin(angle) * (dist/40);
        });
        document.getElementById('joystick-base').addEventListener('pointerup', () => {
            knob.style.transform = 'translate(0,0)';
            moveData = { x: 0, y: 0 };
        });

        // --- SCHIEßEN ---
        window.shoot = (color) => {
            const hand = color === 'blue' ? blueHand : redHand;
            hand.position.z = -4;
            setTimeout(() => hand.position.z = -0.8, 200);
        };

        // --- UMSCHAUEN (TOUCH & MAUS) ---
        let isPointerDown = false;
        window.addEventListener('pointerdown', () => isPointerDown = true);
        window.addEventListener('pointerup', () => isPointerDown = false);
        window.addEventListener('pointermove', (e) => {
            if(!gameActive || (e.clientX < 200 && e.clientY > window.innerHeight - 200)) return; 
            if(isPointerDown || document.pointerLockElement) {
                lookData.lon += e.movementX * 0.2 || 0;
                lookData.lat -= e.movementY * 0.2 || 0;
            }
        });

        // --- GAME LOOP ---
        function animate() {
            if(!gameActive) return;
            requestAnimationFrame(animate);

            // Bewegung
            camera.translateZ(moveData.y * 0.1);
            camera.translateX(moveData.x * 0.1);
            camera.position.y = 1.6;

            // Rotation
            lookData.lat = Math.max(-85, Math.min(85, lookData.lat));
            const phi = THREE.MathUtils.degToRad(90 - lookData.lat);
            const theta = THREE.MathUtils.degToRad(lookData.lon);
            const target = new THREE.Vector3();
            target.setFromSphericalCoords(1, phi, theta).add(camera.position);
            camera.lookAt(target);

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
